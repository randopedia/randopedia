<div class="tour-edit">

    {{#if draftValidationErrors}}
    <div class="row">
        <div class="col-xs-12">
            <div class="alert alert-danger" role="alert">
                <button type="button" class="close" data-dismiss="alert"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
                Couldn't save tour, name must be set.
            </div>
        </div>
    </div>
    {{/if}}

    {{#if isDraft}}
    <div class="row">
        <div class="col-xs-12">
            <div class="alert alert-warning alert-dismissible" role="alert">
                <button type="button" class="close" data-dismiss="alert"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
                {{text "tour_tourIsDraft"}}
            </div>
        </div>
    </div>
    {{/if}}

    {{#if isDeleted}}
    <div class="row">
        <div class="col-xs-12">
            <div class="alert alert-danger" role="alert">
                <button type="button" class="close" data-dismiss="alert"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
                Tour is marked as deleted and will eventually be permanently deleted from the databse.
            </div>
        </div>
    </div>
    {{/if}}

    <div class="row">
        <div class="col-xs-12">
            <div class="alert alert-info text-center" role="alert">
            {{#if hasChanges}}
                {{#if havePendingOperations}}
                <i class="fa fa-floppy-o"></i><em> {{text "tourEdit_saving"}}...</em>
                {{else}}
                <i class="fa fa-floppy-o"></i><em> {{text "tourEdit_unsavedChanges"}}</em>
                {{/if}}
            {{else}}
                <span> {{text "tourEdit_noChanges"}}</span>
            {{/if}}
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-xs-12">

            <ul class="nav nav-pills" role="tablist">
                <li class="nav-item"><a class="nav-link active" href="#details-panel" role="tab" data-toggle="pill">{{text "tourEdit_details"}}</a></li>
                <li class="nav-item"><a class="nav-link" href="#map-panel" role="tab" data-toggle="pill">{{text "tourEdit_map"}}</a></li>
                <li class="nav-item"><a class="nav-link" href="#images-panel" role="tab" data-toggle="pill">{{text "tour_images"}}</a></li>
                <li class="nav-item right"><a class="nav-link" href="#history-panel" role="tab" data-toggle="pill">{{text "tourEdit_history"}}</a></li>
            </ul>

            <div class="tab-content">
                <div class="tab-pane active" id="details-panel">
                    <form role="form">

                        <div class="row">
                            <div class="col-xs-12 col-md-8">
                                <div class="form-group">
                                    <label for="inputName">{{text "tourEdit_nameOfTour"}}</label>
                                    <button type="button" class="info pull-right" data-toggle="popover" data-placement="right" data-trigger="focus" title="Name" data-content="The name of the tour. Name is required and must be between 3 and 80 characters long."></button>
                                    <div class="{{unless nameIsValid 'validation-error'}}">
                                        {{input placeholder="" pattern="^.{3,80}$" value=tour.name id="inputName" class="form-control"}}
                                    </div>
                                </div> 
                            </div>
                            <div class="col-xs-12 col-md-4">
                                <div class="form-group">
                                    <label for="inputCountry">{{text "tourEdit_country"}}</label>
                                    <button type="button" class="info pull-right" data-toggle="popover" data-trigger="focus"
                                            title="Country"
                                            data-content="The country where the tour is located."></button>
                                    {{#x-select class="form-control" value=tour.country action="selectCountry" as |xs|}}
                                        {{#each countries as |country|}}
                                            {{#xs.option value=country.value}} {{country.name}} {{/xs.option}}
                                        {{/each}}
                                    {{/x-select}}
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-xs-12">
                                <div class="form-group">
                                    <label for="inputAccessPoint">{{text "tour_accessPoint"}}</label>
                                    <button type="button" class="info pull-right" data-toggle="popover" data-trigger="focus"
                                            title="Access point"
                                            data-content="Description of the access point and how to get there. The access point description can have a maximum of 1000 characters."></button>
                                            <div class="{{unless accessPointIsValid 'validation-error'}}">
                                                {{textarea value=tour.accessPoint maxlength="1000" id="inputAccessPoint" class="form-control" }}
                                            </div>
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-xs-12">
                                <div class="form-group">
                                    <label for="inputDescription">{{text "tour_description"}}</label>
                                    <button type="button" class="info pull-right" data-toggle="popover" data-trigger="focus"
                                            title="Description"
                                            data-content="Description of the tour itinerary and anything else that could be useful. Description can have a maximum of 10000 characters."></button>
                                            <div class="{{unless descriptionIsValid 'validation-error'}}">
                                                {{textarea value=tour.itinerary maxlength="10000" id="inputDescription" rows="8" class="form-control"}}
                                            </div>
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-xs-12">
                                <div class="form-group">
                                    <label for="tagsEditorId">{{text "tour_tags"}}</label>
                                    <button type="button" class="info pull-right" data-toggle="popover" data-trigger="focus"
                                            title="Tags"
                                            data-content="Add tags describing the location and characteristics of the tour, i.e. 'chamonix', 'couloir' etc."></button>
                                            <div class="{{unless tagsAreValid 'validation-error'}}">
                                                {{tag-editor tags=allTags selectedTags=tour.tags action="tagsUpdated"}}
                                            </div>
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-lg-3">
                                <div class="form-group">
                                    <label for="inputElevationLoss">{{text "tourEdit_elevationLoss"}}</label>
                                    <button type="button" class="info pull-right" data-toggle="popover" data-trigger="focus"
                                            title="Elevation loss"
                                            data-content="Total elevation to descend. Meters."></button>
                                    <div class="input-group {{unless elevationLossIsValid 'validation-error'}}">
                                        {{input pattern=numberRegex value=tour.elevationLoss id="inputElevationLoss" class="form-control"}}
                                        <div class="input-group-addon">m</div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-lg-3">
                                <div class="form-group">
                                    <label for="inputElevationGain">{{text "tourEdit_elevationGain"}}</label>
                                    <button type="button" class="info pull-right" data-toggle="popover" data-trigger="focus"
                                            title="Elevation gain"
                                            data-content="Total elevation to climb. Meters."></button>
                                    <div class="input-group {{unless elevationGainIsValid 'validation-error'}}">
                                        {{input pattern=numberRegex value=tour.elevationGain id="inputElevationGain" class="form-control"}}
                                        <div class="input-group-addon">m</div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-lg-3">
                                <div class="form-group">
                                    <label for="inputHighestPoint">{{text "tourEdit_highestPoint"}}</label>
                                    <button type="button" class="info pull-right" data-toggle="popover" data-trigger="focus"
                                            title="Highest point"
                                            data-content="The highest point of the tour. Meters."></button>
                                    <div class="input-group {{unless elevationMaxIsValid 'validation-error'}}">
                                        {{input placeholder="" pattern=numberRegex value=tour.elevationMax id="inputHighestPoint" class="form-control"}}
                                        <div class="input-group-addon">m</div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-lg-3">
                                <div class="form-group">
                                    <label for="inputAspect">{{text "tourEdit_mainAspect"}}</label>
                                    <button type="button" class="info pull-right" data-toggle="popover" data-trigger="focus"
                                            title="Aspect"
                                            data-content="Aspect of the main part of the slopes on the descent route."></button>
                                        {{#x-select value=aspect action="selectAspect" as |xs|}}
                                            {{#each aspects as |aspect|}}
                                                {{#xs.option value=aspect.value}} {{aspect.name}} {{/xs.option}}
                                            {{/each}}
                                        {{/x-select}}
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-lg-3">
                                <div class="form-group">
                                    <label for="inputTimeMin">{{text "tourEdit_timeMin"}}</label>
                                    <button type="button" class="info pull-right" data-toggle="popover" data-trigger="focus"
                                            title="Time min"
                                            data-content="The minimum amount of time that can be expected for the tour. Hours."></button>
                                    <div class="input-group {{unless timingMinIsValid 'validation-error'}}">
                                        {{input placeholder="" pattern=numberRegex value=tour.timingMin id="inputTimeMin" class="form-control"}}
                                        <div class="input-group-addon">h</div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-lg-3">
                                <div class="form-group">
                                    <label for="inputTimeMax">{{text "tourEdit_timeMax"}}</label>
                                    <button type="button" class="info pull-right" data-toggle="popover" data-trigger="focus"
                                            title="Time max"
                                            data-content="The maximum amount of time that can be expected for the tour. Hours."></button>
                                    <div class="input-group {{unless timingMaxIsValid 'validation-error'}}">
                                        {{input placeholder="" pattern=numberRegex value=tour.timingMax id="inputTimeMax" class="form-control"}}
                                        <div class="input-group-addon">h</div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-lg-3">
                                <div class="form-group">
                                    <label for="inputSeasonFrom">{{text "tourEdit_seasonFrom"}}</label>
                                    <button type="button" class="info pull-right" data-toggle="popover" data-trigger="focus"
                                            title="Season from"
                                            data-content="First month of the season when the tour normally is skiable."></button>
                                        {{#x-select value=tour.timeOfYearFrom action="selectTimeOfYearFrom" as |xs|}}
                                            {{#each months as |month|}}
                                                {{#xs.option value=month.value}} {{month.name}} {{/xs.option}}
                                            {{/each}}
                                        {{/x-select}}
                                </div>
                            </div>
                            <div class="col-lg-3">
                                <div class="form-group">
                                    <label for="inputTimeOfYearTo">{{text "tourEdit_seasonTo"}}</label>
                                    <button type="button" class="info pull-right" data-toggle="popover" data-trigger="focus"
                                            title="Season to"
                                            data-content="Last month of the season when the tour normally is skiable."></button>
                                        {{#x-select value=tour.timeOfYearTo action="selectTimeOfYearTo" as |xs|}}
                                            {{#each months as |month|}}
                                                {{#xs.option value=month.value}} {{month.name}} {{/xs.option}}
                                            {{/each}}
                                        {{/x-select}}
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-lg-3">
                                <div class="form-group">
                                    <label for="inputGrade">{{text "tour_grade"}}</label>
                                    <a class="info pull-right" data-toggle="modal" data-target="#tourDetailsGradeGuideModal"></a>
                                    {{#x-select value=tour.grade action="selectGrade" as |xs|}}
                                        {{#each grades as |grade|}}
                                            {{#xs.option value=grade.value}} {{grade.name}} {{/xs.option}}
                                        {{/each}}
                                    {{/x-select}}
                                </div>
                            </div>

                            <div class="col-lg-3">
                                <div class="form-group">
                                    <label for="inputSteepness">{{text "tourEdit_steepnessMax"}}</label>
                                    <button type="button" class="info pull-right" data-toggle="popover" data-trigger="focus"
                                            title="Steepness"
                                            data-content="Degrees on the steepest part of the route. Degrees, 0-90."></button>
                                    <div class="input-group {{unless degreesMaxIsValid 'validation-error'}}">
                                        {{input pattern=numberRegex value=tour.degreesMax id="inputSteepness" class="form-control"}}
                                        <div class="input-group-addon">&#176;</div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <span class="checkbox">
                                        <label class={{if haveHazards 'checked'}}>
                                            {{input type="checkbox" checkedBinding="tour.haveHazards" class="hide"}}
                                            <span class="glyphicon glyphicon-ok"></span>
                                            <span>{{text "tour_hazards"}}</span>
                                        </label>
                                    </span>
                                    <button type="button" class="info pull-right" data-toggle="popover" data-trigger="focus"
                                            title="Hazards"
                                            data-content="Description of any special hazards that skiers should be aware of. Description can have a maximum of 500 characters."></button>
                                    {{textarea value=tour.hazardsDescription disabledBinding="haveNoHazards" maxlength="500" id="inputHazards" class="form-control"}}
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <span class="checkbox">
                                        <label class={{if requiresTools 'checked'}}>
                                            {{input type="checkbox" checkedBinding="tour.requiresTools" class="hide"}}
                                            <span class="glyphicon glyphicon-ok"></span>
                                            <span>{{text "tourEdit_mountaineering"}}</span>
                                        </label>
                                    </span>
                                    <button type="button" class="info pull-right" data-toggle="popover" data-trigger="focus"
                                            title="Skills/Equipment"
                                            data-content="Description of any mountaineering skills or equipment needed. Rappels, glacier safety equipment etc. Description can have a maximum of 500 characters."></button>
                                    {{textarea value=tour.toolsDescription disabledBinding="doesNotRequireTools" maxlength="500" id="inputTools" class="form-control"}}
                                </div>
                            </div>
                        </div>

                    </form>

                </div>

                <div id="map-panel" class="tab-pane">
                    <div class="row">
                        <div class="col-xs-12">
                            {{map-editor tour=tour}}
                        </div>
                    </div>
                </div>

                <div id="images-panel" class="tab-pane">
                    <div class="row">
                        <div class="col-xs-12">
                            <div class="spacing">
                                {{#if isNew}}
                                <p>Images cannot be uploaded until tour is saved. Publish or save as draft and then come back!</p>
                                {{else}}
                                {{image-editor tour=tour}}
                                {{/if}}
                            </div>
                        </div>
                    </div>
                </div>

                <div id="history-panel" class="tab-pane">
                    <div class="row">
                        <div class="col-xs-12 spacing">
                            Tour status: <em>{{displayStatus}}</em>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-xs-12">
                            <div class="table-responsive">
                                <table class="table table-striped">
                                    <thead>
                                        <tr>
                                            <th>Time</th>
                                            <th>Type</th>
                                            <th>User</th>
                                            <th>Comment</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {{#each action in sortedActions}}
                                        <tr>
                                            <td>{{displayTimestamp action.time}}</td>
                                            <td>{{resolveTourAction action.type}}</td>
                                            <td>{{action.userName}}</td>
                                            <td>{{action.comment}}</td>
                                        </tr>
                                        {{/each}}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <div class="row">
        <div class="col-xs-12">
            <div class="edit-toolbar" role="toolbar">
                <div class="btn-toolbar">
                    <div class="btn-group right">
                        <button class="btn btn-secondary" {{action "startCancelingEditTour" }}>
                            <i class="fa fa-times"></i> {{text "tourEdit_exit"}}
                        </button>
                    </div>

                    <div class="btn-group right">
                        <button class="btn btn-secondary" data-toggle="modal" data-target="#editTourHelpModal">
                            <i class="fa fa-question"></i> {{text "header_help"}}
                        </button>
                    </div>

                    <div class="btn-group">
                        <button class="btn btn-primary" disabled={{isStartPublishDisabled}} {{action "startPublishTour" }}>
                            <i class="fa fa-cloud-upload"></i> {{text "tourEdit_publish"}}
                        </button>
                        
                        {{#unless isPublished}}
                            <button class="btn btn-secondary" disabled={{isSendToReviewDisabled}} {{action "sendToReview" }}>
                                <i class="fa fa-eye"></i> {{text "tourEdit_sendToReview"}}
                            </button>

                            {{#unless isInReview}}
                            <button class="btn btn-secondary" disabled={{isSaveAsDraftDisabled}} {{action "saveAsDraft" }}>
                                <i class="fa fa-floppy-o"></i> {{text "tourEdit_saveAsDraft"}}
                            </button>
                            {{/unless}}

                        {{/unless}}
                    </div>

                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="tourDetailsGradeGuideModal" tabindex="-1" role="dialog" aria-hidden="true">
        <div class="modal-dialog modal-lg login-view">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
                    <h4 class="modal-title" id="myModalLabel">Grades</h4>
                </div>
                <div class="modal-body">
                    {{partial "partials/about-grades"}}
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="discardChangesTourModal" tabindex="-1" role="dialog" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h4>Unsaved changes</h4>
                </div>
                <div class="modal-body">
                    The tour has unsaved changes, do you want to discard them?
                </div>
                <div class="modal-footer">
                    <button class="btn btn-default pull-right" data-dismiss="modal">Cancel</button>
                    <button class="btn btn-danger pull-right" {{action "confirmDiscardChanges" }}>Discard changes</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="confirmDeleteTourModal" tabindex="-1" role="dialog" aria-hidden="true" data-backdrop="static">
        <div class="modal-dialog modal-lg areapicker-view">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
                    <h4 class="modal-title">Delete tour</h4>
                </div>
                <div class="modal-body">
                    Are you sure you want to delete the tour?
                </div>
                <div class="modal-footer">
                    <button class="btn btn-default pull-right" data-dismiss="modal">Cancel</button>
                    <button class="btn btn-danger pull-right" {{action "confirmDeleteTour"}}>Delete tour</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="publishTourStep1Modal" tabindex="-1" role="dialog" aria-hidden="true" data-backdrop="static">

        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
                    <h4 class="modal-title">Publish tour (Step 1 of 2)</h4>
                </div>
                <div class="modal-body">
                    {{#if haveValidationErrors}}
                    <div class="alert alert-danger" role="alert">
                        Tour data is invalid or incomplete
                    </div>

                    <div>
                        <p>The tour are missing some required data and cannot be published.</p>
                        <p>{{text "tourEdit_requiredFieldInfo"}}</p>
                    </div>
                    {{else}}
                    <div class="alert alert-success" role="alert">
                        Tour data is valid
                    </div>
                    <p>Tour is ready to be published.</p>
                    {{/if}}
                </div>
                <div class="modal-footer">
                    <button class="btn btn-default pull-right" data-dismiss="modal">Cancel</button>
                    <button class="btn btn-primary pull-right" disabled={{haveValidationErrors}} {{action "continueToPublishStep2"}}>Continue</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="publishTourStep2Modal" tabindex="-1" role="dialog" aria-hidden="true" data-backdrop="static">

        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
                    <h4 class="modal-title">Publish tour (Step 2 of 2)</h4>
                </div>
                <div class="modal-body">
                    <form role="form">
                        <div class="form-group">
                            <label for="inputPublishComment">What did you change?</label>
                            {{textarea id="inputChangeComment" class="form-control" value=publishComment maxlength="500"}}
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-default pull-right" data-dismiss="modal">Cancel</button>
                    <button class="btn btn-primary pull-right" disabled={{isPublishDisabled}} {{action "confirmPublishTour" }}><span class="glyphicon glyphicon-cloud-upload"></span> Publish</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="editTourHelpModal" tabindex="-1" role="dialog" aria-hidden="true">

        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
                    <h4 class="modal-title">Help</h4>
                </div>
                <div class="modal-body">
                    {{partial "partials/about-collaboration"}}
                </div>
                <div class="modal-footer">
                    <button class="btn btn-default pull-right" data-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

</div>
